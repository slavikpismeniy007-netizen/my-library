<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя библиотека с Яндекс.Диском</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #ffb8e0;
            --secondary-color: #d8a7ff;
            --accent-color: #ff7eb3;
            --light-color: #fff5fa;
            --dark-color: #6d4c5c;
            --text-color: #5a4a4f;
        }

        body {
            background-color: #fffafc;
            color: var(--text-color);
            line-height: 1.6;
            background-image: linear-gradient(to bottom, #fff5fa 0%, #fff 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(255, 120, 180, 0.15);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 1px, transparent 1px);
            background-size: 30px 30px;
            z-index: 0;
        }

        header h1 {
            font-size: 3rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        header p {
            font-size: 1.2rem;
            color: white;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Яндекс статус */
        .yandex-status {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ff7e7e;
        }

        .status-dot.connected {
            background-color: #7dce94;
        }

        .storage-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            display: none;
        }

        .storage-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .storage-used {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .yandex-auth-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            color: var(--dark-color);
        }

        .library-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            min-width: 120px;
        }

        .stat-box h3 {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 0.9rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        .search-sort-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #f0e6ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: white;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 184, 224, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-size: 1.2rem;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
        }

        .sort-btn {
            background: white;
            border: 2px solid #f0e6ed;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--dark-color);
        }

        .sort-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .sort-btn:hover {
            border-color: var(--primary-color);
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .add-book-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            border: 2px dashed var(--primary-color);
        }

        .books-section {
            flex: 2;
            min-width: 300px;
        }

        h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 i {
            color: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-color);
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #f0e6ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 184, 224, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .cover-upload {
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .cover-upload:hover {
            background-color: rgba(216, 167, 255, 0.05);
            border-color: var(--accent-color);
        }

        .cover-upload i {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        #book-cover-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            object-fit: cover;
            width: 100%;
        }

        .btn {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .btn-secondary {
            background: white;
            color: var(--dark-color);
            border: 2px solid #f0e6ed;
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
        }

        .btn-yandex {
            background: linear-gradient(to right, #fc3f1d, #ffcc00);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(255, 120, 180, 0.3);
        }

        .books-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .book-card {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .book-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .book-cover {
            height: 200px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .book-card:hover .book-cover img {
            transform: scale(1.05);
        }

        .default-cover {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .default-cover i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .book-info {
            padding: 20px;
        }

        .book-title {
            font-size: 1.3rem;
            color: var(--dark-color);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .book-author {
            color: var(--accent-color);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .book-description {
            color: var(--text-color);
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .book-meta {
            display: flex;
            justify-content: space-between;
            color: #aaa;
            font-size: 0.85rem;
            border-top: 1px solid #f5f5f5;
            padding-top: 15px;
        }

        .book-status {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 2;
        }

        .read {
            color: #7dce94;
        }

        .unread {
            color: #ff9a76;
        }

        .book-actions {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2;
        }

        .book-card:hover .book-actions {
            opacity: 1;
        }

        .action-btn {
            background-color: rgba(255, 255, 255, 0.9);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-btn {
            color: #7d7eff;
        }

        .delete-btn {
            color: #ff7e7e;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .empty-library {
            text-align: center;
            padding: 50px 20px;
            color: #ccc;
            width: 100%;
        }

        .empty-library i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #f0e6ed;
        }

        .search-results-info {
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: rgba(255, 184, 224, 0.1);
            border-radius: 10px;
            color: var(--dark-color);
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            gap: 15px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s;
        }

        /* Модальное окно с информацией о книге */
        #book-info-modal .modal-content {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .book-info-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }

        .book-info-cover {
            width: 200px;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-right: 30px;
            flex-shrink: 0;
        }

        .book-info-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-info-default-cover {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .book-info-default-cover i {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .book-info-content {
            flex: 1;
        }

        .book-info-title {
            font-size: 2.2rem;
            color: var(--dark-color);
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .book-info-author {
            font-size: 1.3rem;
            color: var(--accent-color);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .book-info-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .meta-item {
            background: rgba(255, 184, 224, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .meta-label {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 1.1rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        .book-info-description {
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--text-color);
            margin-bottom: 30px;
            white-space: pre-line;
        }

        .book-info-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .book-info-header-row {
            display: flex;
            align-items: flex-start;
        }

        .book-info-date {
            color: #aaa;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .library-stats {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .search-sort-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .yandex-status {
                flex-direction: column;
                align-items: stretch;
            }
            
            .book-info-header-row {
                flex-direction: column;
            }
            
            .book-info-cover {
                width: 100%;
                height: 250px;
                margin-right: 0;
                margin-bottom: 25px;
            }
            
            .book-info-title {
                font-size: 1.8rem;
            }
            
            .book-info-meta {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-book-heart"></i> Моя библиотека с Яндекс.Диском</h1>
            <p>Ваши книги сохраняются в облаке Яндекс.Диска</p>
            
            <div class="yandex-status">
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">Загрузка статуса...</span>
                </div>
                <button class="btn btn-small btn-yandex" id="sync-now-btn">
                    <i class="fas fa-sync-alt"></i> Синхронизировать сейчас
                </button>
            </div>
            
            <div class="library-stats">
                <div class="stat-box">
                    <h3 id="total-books">0</h3>
                    <p>Всего книг</p>
                </div>
                <div class="stat-box">
                    <h3 id="read-books">0</h3>
                    <p>Прочитано</p>
                </div>
                <div class="stat-box">
                    <h3 id="unread-books">0</h3>
                    <p>Ещё прочитать</p>
                </div>
            </div>
            
            <div class="storage-info" id="storage-info">
                <div>Использовано: <span id="storage-used">0</span> из <span id="storage-total">0</span></div>
                <div class="storage-bar">
                    <div class="storage-used" id="storage-bar"></div>
                </div>
            </div>
        </header>
        
        <div class="yandex-auth-info" id="yandex-auth-info" style="display: none;">
            <h3><i class="fab fa-yandex"></i> Подключение к Яндекс.Диску</h3>
            <p>Нажмите кнопку ниже для подключения. Данные будут сохраняться в папку "Моя библиотека" на вашем Яндекс.Диске.</p>
            <button class="btn btn-yandex" id="connect-btn">
                <i class="fab fa-yandex"></i> Подключить Яндекс.Диск
            </button>
        </div>
        
        <div class="main-content">
            <section class="add-book-section">
                <h2><i class="fas fa-plus-circle"></i> 
                    <span id="form-title">Добавить новую книгу</span>
                </h2>
                
                <form id="add-book-form">
                    <input type="hidden" id="book-id" value="">
                    
                    <div class="form-group">
                        <label for="book-title">Название книги *</label>
                        <input type="text" id="book-title" placeholder="Введите название книги" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="book-author">Автор *</label>
                        <input type="text" id="book-author" placeholder="Введите имя автора" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="book-description">Описание книги</label>
                        <textarea id="book-description" placeholder="Краткое описание книги (необязательно)" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="book-genre">Жанр</label>
                        <select id="book-genre">
                            <option value="Роман">Роман</option>
                            <option value="Фантастика">Фантастика</option>
                            <option value="Фэнтези">Фэнтези</option>
                            <option value="Детектив">Детектив</option>
                            <option value="Поэзия">Поэзия</option>
                            <option value="Биография">Биография</option>
                            <option value="Научная">Научная литература</option>
                            <option value="Другое">Другое</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="book-status">Статус</label>
                        <select id="book-status">
                            <option value="read">Прочитана</option>
                            <option value="unread">Хочу прочитать</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Обложка книги</label>
                        <div class="cover-upload" id="cover-upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Нажмите для загрузки обложки</p>
                            <input type="file" id="book-cover" accept="image/*" style="display: none;">
                            <img id="book-cover-preview" alt="Предпросмотр обложки">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn" id="submit-btn">
                            <i class="fas fa-book-medical"></i> 
                            <span id="submit-text">Добавить в библиотеку</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;">
                            <i class="fas fa-times"></i> Отменить
                        </button>
                    </div>
                </form>
            </section>
            
            <section class="books-section">
                <div class="search-sort-container">
                    <div class="search-box">
                        <input type="text" id="search-input" class="search-input" placeholder="Поиск книг по названию, автору или жанру...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="sort-buttons">
                        <button class="sort-btn active" data-sort="title-asc">По названию А-Я</button>
                        <button class="sort-btn" data-sort="title-desc">По названию Я-А</button>
                        <button class="sort-btn" data-sort="author">По автору</button>
                    </div>
                </div>
                
                <div class="search-results-info" id="search-results-info">
                    Найдено книг: <span id="search-count">0</span>. <a href="#" id="clear-search">Очистить поиск</a>
                </div>
                
                <div class="books-container" id="books-container">
                    <div class="empty-library" id="empty-library-message">
                        <i class="fas fa-book-open"></i>
                        <h3>Ваша библиотека пуста</h3>
                        <p>Добавьте свою первую книгу, используя форму слева</p>
                    </div>
                </div>
            </section>
        </div>
        
        <footer>
            <p>Создано с <i class="fas fa-heart" style="color: var(--accent-color);"></i> для книголюбов</p>
            <p>© 2023 Моя библиотека с Яндекс.Диском</p>
            <p style="margin-top: 10px; font-size: 0.8rem; color: #bbb;">
                <i class="fas fa-info-circle"></i> 
                Все данные сохраняются в вашем Яндекс.Диске (10 ГБ бесплатно)
            </p>
        </footer>
    </div>

    <!-- Модальное окно для удаления -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.5rem; color: var(--accent-color);">Удаление книги</h3>
                <button class="close-modal" id="close-delete-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #aaa;">&times;</button>
            </div>
            <p>Вы уверены, что хотите удалить книгу "<span id="delete-book-title"></span>"?</p>
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn" id="confirm-delete-btn">Да, удалить</button>
                <button class="btn btn-secondary" id="cancel-delete-btn">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно с полной информацией о книге -->
    <div class="modal" id="book-info-modal">
        <div class="modal-content">
            <div class="book-info-modal-header">
                <h2 style="font-size: 1.8rem; color: var(--accent-color); flex: 1;">Информация о книге</h2>
                <button class="close-modal" id="close-book-info-modal" style="background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #aaa; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                    &times;
                </button>
            </div>
            
            <div class="book-info-header-row">
                <div class="book-info-cover">
                    <div class="book-info-default-cover" id="book-info-default-cover">
                        <i class="fas fa-book"></i>
                        <div id="book-info-initials"></div>
                    </div>
                    <img id="book-info-cover-img" alt="Обложка книги" style="display: none;">
                </div>
                
                <div class="book-info-content">
                    <h1 class="book-info-title" id="book-info-title">Название книги</h1>
                    <p class="book-info-author" id="book-info-author">Автор книги</p>
                    
                    <div class="book-info-meta">
                        <div class="meta-item">
                            <div class="meta-label">Жанр</div>
                            <div class="meta-value" id="book-info-genre">Роман</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Статус</div>
                            <div class="meta-value" id="book-info-status">Прочитана</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Добавлено</div>
                            <div class="meta-value" id="book-info-date">Сегодня</div>
                        </div>
                    </div>
                    
                    <div class="book-info-description" id="book-info-description">
                        Здесь будет полное описание книги...
                    </div>
                    
                    <div class="book-info-actions">
                        <button class="btn btn-small edit-from-info" id="edit-from-info-btn">
                            <i class="fas fa-edit"></i> Редактировать
                        </button>
                        <button class="btn btn-small btn-secondary close-book-info">
                            <i class="fas fa-times"></i> Закрыть
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // КОНФИГУРАЦИЯ С ВАШИМИ ДАННЫМИ
        // ============================================
        const YANDEX_CLIENT_ID = '0fdb34daa6b84b9e9029f886d4e42def';
        const YANDEX_REDIRECT_URI = 'https://oauth.yandex.ru/verification_code';
        
        // ============================================
        // ПЕРЕМЕННЫЕ ПРИЛОЖЕНИЯ
        // ============================================
        let books = [];
        let currentSort = 'title-asc';
        let bookToDelete = null;
        let isEditing = false;
        let currentEditId = null;
        let searchQuery = '';
        let filteredBooks = [];
        let isYandexConnected = false;
        let yandexToken = null;
        let currentBookViewId = null;
        
        // ============================================
        // ЭЛЕМЕНТЫ DOM
        // ============================================
        const booksContainer = document.getElementById('books-container');
        const addBookForm = document.getElementById('add-book-form');
        const coverUploadArea = document.getElementById('cover-upload-area');
        const bookCoverInput = document.getElementById('book-cover');
        const bookCoverPreview = document.getElementById('book-cover-preview');
        const emptyLibraryMessage = document.getElementById('empty-library-message');
        const totalBooksElement = document.getElementById('total-books');
        const readBooksElement = document.getElementById('read-books');
        const unreadBooksElement = document.getElementById('unread-books');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const formTitle = document.getElementById('form-title');
        const submitText = document.getElementById('submit-text');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const bookIdInput = document.getElementById('book-id');
        const deleteModal = document.getElementById('delete-modal');
        const deleteBookTitle = document.getElementById('delete-book-title');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const closeDeleteModal = document.getElementById('close-delete-modal');
        const searchInput = document.getElementById('search-input');
        const searchResultsInfo = document.getElementById('search-results-info');
        const searchCount = document.getElementById('search-count');
        const clearSearch = document.getElementById('clear-search');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const connectBtn = document.getElementById('connect-btn');
        const syncNowBtn = document.getElementById('sync-now-btn');
        const storageInfo = document.getElementById('storage-info');
        const storageUsed = document.getElementById('storage-used');
        const storageTotal = document.getElementById('storage-total');
        const storageBar = document.getElementById('storage-bar');
        const yandexAuthInfo = document.getElementById('yandex-auth-info');
        
        // Элементы модального окна с информацией о книге
        const bookInfoModal = document.getElementById('book-info-modal');
        const bookInfoTitle = document.getElementById('book-info-title');
        const bookInfoAuthor = document.getElementById('book-info-author');
        const bookInfoGenre = document.getElementById('book-info-genre');
        const bookInfoStatus = document.getElementById('book-info-status');
        const bookInfoDate = document.getElementById('book-info-date');
        const bookInfoDescription = document.getElementById('book-info-description');
        const bookInfoCoverImg = document.getElementById('book-info-cover-img');
        const bookInfoDefaultCover = document.getElementById('book-info-default-cover');
        const bookInfoInitials = document.getElementById('book-info-initials');
        const closeBookInfoModal = document.getElementById('close-book-info-modal');
        const closeBookInfoBtn = document.querySelector('.close-book-info');
        const editFromInfoBtn = document.getElementById('edit-from-info-btn');

        // ============================================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ============================================
        function initializeApp() {
            console.log('Инициализация приложения...');
            
            // Загружаем книги из localStorage
            loadBooksFromLocalStorage();
            
            // Проверяем токен Яндекс
            checkYandexToken();
            
            // Отображаем книги
            displayBooks();
            
            // Обновляем статус
            updateYandexStatus();
            
            // Добавляем примерные книги если пусто
            if (books.length === 0) {
                addSampleBooks();
            }
        }

        // ============================================
        // ФУНКЦИЯ ПОКАЗА ПОЛНОЙ ИНФОРМАЦИИ О КНИГЕ
        // ============================================
        function showBookInfo(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;
            
            currentBookViewId = id;
            
            // Заполняем информацию
            bookInfoTitle.textContent = book.title;
            bookInfoAuthor.textContent = book.author;
            bookInfoGenre.textContent = book.genre || 'Роман';
            bookInfoStatus.textContent = book.status === 'read' ? 'Прочитана' : 'Хочу прочитать';
            bookInfoDescription.textContent = book.description || 'Описание отсутствует';
            
            // Форматируем дату
            if (book.addedDate) {
                const date = new Date(book.addedDate);
                bookInfoDate.textContent = date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            } else {
                bookInfoDate.textContent = 'Неизвестно';
            }
            
            // Отображаем обложку
            if (book.cover) {
                bookInfoCoverImg.src = book.cover;
                bookInfoCoverImg.style.display = 'block';
                bookInfoDefaultCover.style.display = 'none';
            } else {
                // Показываем заглушку с инициалами
                const initials = book.title.split(' ').map(word => word[0]).join('').toUpperCase();
                bookInfoInitials.textContent = initials.substring(0, 3);
                bookInfoCoverImg.style.display = 'none';
                bookInfoDefaultCover.style.display = 'flex';
            }
            
            // Показываем модальное окно
            bookInfoModal.style.display = 'flex';
        }

        // ============================================
        // ПРОВЕРКА ТОКЕНА ЯНДЕКС
        // ============================================
        function checkYandexToken() {
            const hash = window.location.hash;
            if (hash.includes('access_token=')) {
                const match = hash.match(/access_token=([^&]*)/);
                if (match && match[1]) {
                    yandexToken = match[1];
                    localStorage.setItem('yandexToken', yandexToken);
                    isYandexConnected = true;
                    
                    window.location.hash = '';
                    
                    showNotification('✅ Яндекс.Диск успешно подключен!');
                    
                    setTimeout(() => {
                        testYandexConnection();
                    }, 1000);
                }
            } else {
                const savedToken = localStorage.getItem('yandexToken');
                if (savedToken) {
                    yandexToken = savedToken;
                    isYandexConnected = true;
                }
            }
        }

        // ============================================
        // АВТОРИЗАЦИЯ ЧЕРЕЗ ЯНДЕКС
        // ============================================
        function connectToYandex() {
            const authUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=${YANDEX_CLIENT_ID}&redirect_uri=${encodeURIComponent(YANDEX_REDIRECT_URI)}`;
            
            console.log('Открываем OAuth страницу:', authUrl);
            
            const authWindow = window.open(authUrl, '_blank', 'width=600,height=700');
            
            if (!authWindow) {
                alert('Браузер заблокировал всплывающее окно. Откройте эту ссылку вручную:\n\n' + authUrl);
            }
            
            setTimeout(() => {
                const token = prompt(
                    'ШАГИ ДЛЯ ПОДКЛЮЧЕНИЯ:\n\n' +
                    '1. В новой вкладке авторизуйтесь в Яндексе\n' +
                    '2. Нажмите "Разрешить"\n' +
                    '3. Скопируйте токен из адресной строки\n' +
                    '4. Вставьте его здесь:\n\n' +
                    'Токен начинается с "y0_" и содержит много символов'
                );
                
                if (token && token.trim()) {
                    processToken(token.trim());
                }
            }, 3000);
        }
        
        function processToken(tokenString) {
            let token = tokenString;
            
            if (tokenString.includes('access_token=')) {
                const match = tokenString.match(/access_token=([^&]*)/);
                if (match && match[1]) {
                    token = match[1];
                }
            }
            
            if (token && token.length > 20) {
                yandexToken = token;
                localStorage.setItem('yandexToken', token);
                isYandexConnected = true;
                
                showNotification('✅ Токен сохранен! Проверяем подключение...');
                updateYandexStatus();
                
                testYandexConnection();
            } else {
                showNotification('❌ Неверный токен');
            }
        }

        // ============================================
        // ТЕСТИРОВАНИЕ ПОДКЛЮЧЕНИЯ К ЯНДЕКС.ДИСКУ
        // ============================================
        async function testYandexConnection() {
            if (!isYandexConnected) return;
            
            try {
                const response = await fetch('https://cloud-api.yandex.net/v1/disk/', {
                    headers: {
                        'Authorization': `OAuth ${yandexToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Подключение успешно!', data);
                    showNotification(`✅ Подключено! Доступно ${formatBytes(data.total_space)}`);
                    updateStorageInfo();
                    
                    setTimeout(() => {
                        loadBooksFromYandex();
                    }, 1000);
                } else {
                    throw new Error('API вернул ошибку');
                }
            } catch (error) {
                console.error('❌ Ошибка подключения:', error);
                showNotification('❌ Ошибка подключения. Проверьте токен.');
                
                localStorage.removeItem('yandexToken');
                isYandexConnected = false;
                yandexToken = null;
                updateYandexStatus();
            }
        }

        // ============================================
        // ОБНОВЛЕНИЕ СТАТУСА ЯНДЕКС
        // ============================================
        function updateYandexStatus() {
            if (isYandexConnected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Подключено к Яндекс.Диску';
                yandexAuthInfo.style.display = 'none';
                storageInfo.style.display = 'block';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Не подключено к Яндекс.Диску';
                yandexAuthInfo.style.display = 'block';
                storageInfo.style.display = 'none';
            }
        }

        // ============================================
        // API ВЫЗОВЫ К ЯНДЕКС.ДИСКУ
        // ============================================
        async function yandexApiCall(method, endpoint, data = null) {
            if (!isYandexConnected) throw new Error('Не подключено к Яндекс.Диску');
            
            const url = `https://cloud-api.yandex.net${endpoint}`;
            const headers = {
                'Authorization': `OAuth ${yandexToken}`,
                'Accept': 'application/json'
            };
            
            const options = { method, headers };
            
            if (data) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`Ошибка API: ${response.status}`);
                }
                
                if (response.status === 204) {
                    return null;
                }
                
                return await response.json();
            } catch (error) {
                console.error('API ошибка:', error);
                throw error;
            }
        }

        // ============================================
        // СОХРАНЕНИЕ КНИГ В ЯНДЕКС.ДИСК
        // ============================================
        async function saveBooksToYandex() {
            if (!isYandexConnected) {
                console.log('Яндекс.Диск не подключен, сохраняем только локально');
                return false;
            }
            
            try {
                const booksJson = JSON.stringify(books, null, 2);
                const filePath = '/library.json';
                
                const uploadUrl = await yandexApiCall(
                    'GET',
                    `/v1/disk/resources/upload?path=${encodeURIComponent(filePath)}&overwrite=true`
                );
                
                const uploadResponse = await fetch(uploadUrl.href, {
                    method: 'PUT',
                    body: booksJson,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (uploadResponse.ok) {
                    console.log('✅ Книги сохранены в Яндекс.Диск');
                    updateStorageInfo();
                    return true;
                } else {
                    throw new Error('Ошибка загрузки файла');
                }
            } catch (error) {
                console.error('❌ Ошибка сохранения в Яндекс.Диск:', error);
                showNotification('⚠️ Ошибка сохранения в облако');
                return false;
            }
        }

        // ============================================
        // ЗАГРУЗКА КНИГ ИЗ ЯНДЕКС.ДИСКА
        // ============================================
        async function loadBooksFromYandex() {
            if (!isYandexConnected) return;
            
            try {
                const filePath = '/library.json';
                
                const downloadUrl = await yandexApiCall(
                    'GET',
                    `/v1/disk/resources/download?path=${encodeURIComponent(filePath)}`
                );
                
                const response = await fetch(downloadUrl.href);
                if (response.ok) {
                    const cloudBooks = await response.json();
                    
                    if (Array.isArray(cloudBooks)) {
                        const localIds = new Set(books.map(book => book.id));
                        const newBooks = cloudBooks.filter(book => !localIds.has(book.id));
                        
                        if (newBooks.length > 0) {
                            books = [...books, ...newBooks];
                            console.log(`✅ Загружено ${newBooks.length} книг из облака`);
                            displayBooks();
                            saveBooksToLocalStorage();
                            showNotification(`Загружено ${newBooks.length} книг из облака`);
                        }
                    }
                }
            } catch (error) {
                console.log('Файл библиотеки не найден в Яндекс.Диске');
            }
        }

        // ============================================
        // ОБНОВЛЕНИЕ ИНФОРМАЦИИ О ХРАНИЛИЩЕ
        // ============================================
        async function updateStorageInfo() {
            if (!isYandexConnected) return;
            
            try {
                const diskInfo = await yandexApiCall('GET', '/v1/disk/');
                
                const used = diskInfo.used_space || 0;
                const total = diskInfo.total_space || 10737418240;
                const percentage = Math.min((used / total) * 100, 100);
                
                storageUsed.textContent = formatBytes(used);
                storageTotal.textContent = formatBytes(total);
                storageBar.style.width = percentage + '%';
            } catch (error) {
                console.error('Ошибка получения информации о хранилище:', error);
            }
        }

        // ============================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // ============================================
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Б';
            const k = 1024;
            const sizes = ['Б', 'КБ', 'МБ', 'ГБ', 'ТБ'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ============================================
        // ФУНКЦИИ БИБЛИОТЕКИ
        // ============================================
        function updateStats() {
            const totalBooks = books.length;
            const readBooks = books.filter(book => book.status === 'read').length;
            const unreadBooks = totalBooks - readBooks;
            
            totalBooksElement.textContent = totalBooks;
            readBooksElement.textContent = readBooks;
            unreadBooksElement.textContent = unreadBooks;
        }

        function searchBooks(query) {
            searchQuery = query.toLowerCase().trim();
            
            if (searchQuery === '') {
                filteredBooks = [...books];
                searchResultsInfo.style.display = 'none';
            } else {
                filteredBooks = books.filter(book => {
                    return (
                        book.title.toLowerCase().includes(searchQuery) ||
                        book.author.toLowerCase().includes(searchQuery) ||
                        (book.genre && book.genre.toLowerCase().includes(searchQuery)) ||
                        (book.description && book.description.toLowerCase().includes(searchQuery))
                    );
                });
                
                searchCount.textContent = filteredBooks.length;
                searchResultsInfo.style.display = 'block';
            }
            
            return filteredBooks;
        }

        function sortBooks(booksToSort) {
            const booksArray = [...booksToSort];
            
            switch(currentSort) {
                case 'title-asc':
                    booksArray.sort((a, b) => a.title.localeCompare(b.title, 'ru'));
                    break;
                case 'title-desc':
                    booksArray.sort((a, b) => b.title.localeCompare(a.title, 'ru'));
                    break;
                case 'author':
                    booksArray.sort((a, b) => a.author.localeCompare(b.author, 'ru'));
                    break;
            }
            
            return booksArray;
        }

        function displayBooks() {
            let booksToDisplay = searchQuery ? searchBooks(searchQuery) : books;
            booksToDisplay = sortBooks(booksToDisplay);
            
            booksContainer.innerHTML = '';
            
            if (booksToDisplay.length === 0) {
                emptyLibraryMessage.style.display = 'block';
                booksContainer.appendChild(emptyLibraryMessage);
                updateStats();
                return;
            }
            
            emptyLibraryMessage.style.display = 'none';
            
            booksToDisplay.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                
                let coverContent = '';
                if (book.cover) {
                    coverContent = `<img src="${book.cover}" alt="${book.title}" loading="lazy">`;
                } else {
                    const firstLetters = book.title.split(' ').map(word => word[0]).join('').toUpperCase();
                    coverContent = `
                        <div class="default-cover">
                            <i class="fas fa-book"></i>
                            <div>${firstLetters.substring(0, 3)}</div>
                        </div>
                    `;
                }
                
                bookCard.innerHTML = `
                    <div class="book-cover">
                        ${coverContent}
                        <div class="book-actions">
                            <div class="action-btn edit-btn" data-id="${book.id}" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn delete-btn" data-id="${book.id}" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </div>
                    <div class="book-info">
                        <h3 class="book-title">${book.title}</h3>
                        <p class="book-author">${book.author}</p>
                        <p class="book-description">${book.description}</p>
                        <div class="book-meta">
                            <span>${book.genre || 'Роман'}</span>
                            <span>${book.status === 'read' ? 'Прочитана' : 'Хочу прочитать'}</span>
                        </div>
                    </div>
                    <div class="book-status ${book.status}">
                        ${book.status === 'read' ? 'Прочитано' : 'К прочтению'}
                    </div>
                `;
                
                booksContainer.appendChild(bookCard);
                
                // Обработчики клика на карточку книги
                bookCard.addEventListener('click', (e) => {
                    // Не открывать информацию, если кликнули на кнопки действий
                    if (!e.target.closest('.book-actions')) {
                        showBookInfo(book.id);
                    }
                });
                
                // Обработчики действий
                bookCard.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editBook(book.id);
                });
                
                bookCard.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteModal(book.id);
                });
            });
            
            updateStats();
        }

        function editBook(id) {
            const book = books.find(b => b.id === id);
            if (book) {
                isEditing = true;
                currentEditId = id;
                
                document.getElementById('book-title').value = book.title;
                document.getElementById('book-author').value = book.author;
                document.getElementById('book-description').value = book.description;
                document.getElementById('book-genre').value = book.genre || 'Роман';
                document.getElementById('book-status').value = book.status;
                bookIdInput.value = id;
                
                if (book.cover) {
                    bookCoverPreview.src = book.cover;
                    bookCoverPreview.style.display = 'block';
                }
                
                formTitle.textContent = 'Редактировать книгу';
                submitText.textContent = 'Сохранить изменения';
                cancelEditBtn.style.display = 'flex';
                
                document.querySelector('.add-book-section').scrollIntoView({ behavior: 'smooth' });
                
                // Закрываем модальное окно информации, если оно открыто
                hideBookInfoModal();
            }
        }

        function cancelEdit() {
            isEditing = false;
            currentEditId = null;
            
            addBookForm.reset();
            bookCoverPreview.style.display = 'none';
            bookCoverPreview.src = '';
            bookIdInput.value = '';
            
            formTitle.textContent = 'Добавить новую книгу';
            submitText.textContent = 'Добавить в библиотеку';
            cancelEditBtn.style.display = 'none';
        }

        function showDeleteModal(id) {
            const book = books.find(b => b.id === id);
            if (book) {
                bookToDelete = id;
                deleteBookTitle.textContent = book.title;
                deleteModal.style.display = 'flex';
            }
        }

        function hideDeleteModal() {
            deleteModal.style.display = 'none';
            bookToDelete = null;
        }

        function hideBookInfoModal() {
            bookInfoModal.style.display = 'none';
            currentBookViewId = null;
        }

        async function deleteBook(id) {
            books = books.filter(book => book.id !== id);
            displayBooks();
            saveBooksToLocalStorage();
            
            if (isYandexConnected) {
                await saveBooksToYandex();
            }
            
            hideDeleteModal();
            hideBookInfoModal();
            showNotification('Книга удалена');
        }

        async function saveBook(title, author, description, genre, status, coverFile) {
            try {
                let coverUrl = null;
                
                if (coverFile) {
                    coverUrl = await fileToBase64(coverFile);
                }
                
                if (isEditing && currentEditId) {
                    const bookIndex = books.findIndex(book => book.id === currentEditId);
                    if (bookIndex !== -1) {
                        books[bookIndex] = {
                            ...books[bookIndex],
                            title,
                            author,
                            description: description || "Описание отсутствует",
                            genre: genre || 'Роман',
                            status,
                            cover: coverUrl || books[bookIndex].cover,
                            addedDate: books[bookIndex].addedDate || new Date().toISOString()
                        };
                        
                        showNotification(`Книга "${title}" обновлена!`);
                        cancelEdit();
                    }
                } else {
                    const newId = books.length > 0 ? Math.max(...books.map(book => book.id)) + 1 : 1;
                    
                    const newBook = {
                        id: newId,
                        title,
                        author,
                        description: description || "Описание отсутствует",
                        genre: genre || 'Роман',
                        status,
                        cover: coverUrl,
                        addedDate: new Date().toISOString()
                    };
                    
                    books.push(newBook);
                    showNotification(`Книга "${title}" добавлена!`);
                }
                
                displayBooks();
                saveBooksToLocalStorage();
                
                if (isYandexConnected) {
                    await saveBooksToYandex();
                }
                
            } catch (error) {
                console.error('Ошибка сохранения книги:', error);
                showNotification('Ошибка сохранения книги');
            }
        }
        
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ============================================
        // ЛОКАЛЬНОЕ ХРАНИЛИЩЕ
        // ============================================
        function saveBooksToLocalStorage() {
            try {
                localStorage.setItem('libraryBooks', JSON.stringify(books));
                localStorage.setItem('librarySort', currentSort);
                localStorage.setItem('librarySearch', searchQuery);
            } catch (error) {
                console.error('Ошибка сохранения:', error);
            }
        }

        function loadBooksFromLocalStorage() {
            try {
                const savedBooks = localStorage.getItem('libraryBooks');
                if (savedBooks) {
                    books = JSON.parse(savedBooks);
                }
                
                const savedSort = localStorage.getItem('librarySort');
                if (savedSort) {
                    currentSort = savedSort;
                    sortButtons.forEach(btn => {
                        if (btn.getAttribute('data-sort') === currentSort) {
                            btn.classList.add('active');
                        }
                    });
                }
                
                const savedSearch = localStorage.getItem('librarySearch');
                if (savedSearch) {
                    searchQuery = savedSearch;
                    searchInput.value = savedSearch;
                }
            } catch (error) {
                console.error('Ошибка загрузки:', error);
            }
        }

        function addSampleBooks() {
            const hasAddedSamples = localStorage.getItem('hasAddedSamples');
            
            if (!hasAddedSamples && books.length === 0) {
                books = [
                    {
                        id: 1,
                        title: "Гордость и предубеждение",
                        author: "Джейн Остин",
                        description: "Классический роман о любви и социальных предрассудках в английской провинции конца XVIII века. История Элизабет Беннет и мистера Дарси - это история преодоления гордости и предрассудков, чтобы найти истинную любовь.",
                        genre: "Роман",
                        status: "read",
                        addedDate: new Date().toISOString()
                    },
                    {
                        id: 2,
                        title: "Маленькие женщины",
                        author: "Луиза Мэй Олкотт",
                        description: "История о четырех сестрах - Мэг, Джо, Бет и Эми, взрослеющих во время Гражданской войны в Америке. Книга рассказывает о семейных ценностях, взрослении, мечтах и преодолении трудностей.",
                        genre: "Роман",
                        status: "read",
                        addedDate: new Date().toISOString()
                    }
                ];
                
                saveBooksToLocalStorage();
                localStorage.setItem('hasAddedSamples', 'true');
            }
        }

        // ============================================
        // ОБРАБОТЧИКИ СОБЫТИЙ
        // ============================================
        coverUploadArea.addEventListener('click', () => {
            bookCoverInput.click();
        });
        
        bookCoverInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    bookCoverPreview.src = e.target.result;
                    bookCoverPreview.style.display = 'block';
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        addBookForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('book-title').value.trim();
            const author = document.getElementById('book-author').value.trim();
            const description = document.getElementById('book-description').value.trim();
            const genre = document.getElementById('book-genre').value;
            const status = document.getElementById('book-status').value;
            
            if (!title || !author) {
                alert('Пожалуйста, заполните обязательные поля');
                return;
            }
            
            const coverFile = bookCoverInput.files && bookCoverInput.files[0];
            saveBook(title, author, description, genre, status, coverFile);
            
            addBookForm.reset();
            bookCoverPreview.style.display = 'none';
        });

        cancelEditBtn.addEventListener('click', cancelEdit);

        sortButtons.forEach(button => {
            button.addEventListener('click', function() {
                sortButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentSort = this.getAttribute('data-sort');
                displayBooks();
                saveBooksToLocalStorage();
            });
        });

        searchInput.addEventListener('input', function() {
            searchBooks(this.value);
            displayBooks();
            saveBooksToLocalStorage();
        });

        clearSearch.addEventListener('click', function(e) {
            e.preventDefault();
            searchInput.value = '';
            searchQuery = '';
            searchResultsInfo.style.display = 'none';
            displayBooks();
            saveBooksToLocalStorage();
        });

        connectBtn.addEventListener('click', connectToYandex);

        syncNowBtn.addEventListener('click', async function() {
            if (isYandexConnected) {
                const success = await saveBooksToYandex();
                if (success) {
                    showNotification('✅ Данные синхронизированы с Яндекс.Диском');
                }
            } else {
                showNotification('⚠️ Сначала подключите Яндекс.Диск');
            }
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (bookToDelete) {
                deleteBook(bookToDelete);
            }
        });

        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        closeDeleteModal.addEventListener('click', hideDeleteModal);

        // Обработчики модального окна с информацией о книге
        closeBookInfoModal.addEventListener('click', hideBookInfoModal);
        closeBookInfoBtn.addEventListener('click', hideBookInfoModal);

        editFromInfoBtn.addEventListener('click', () => {
            if (currentBookViewId) {
                editBook(currentBookViewId);
                hideBookInfoModal();
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target === deleteModal) hideDeleteModal();
            if (e.target === bookInfoModal) hideBookInfoModal();
        });

        // Закрытие по Esc
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideDeleteModal();
                hideBookInfoModal();
            }
        });

        // ============================================
        // ЗАГРУЗКА ПРИЛОЖЕНИЯ
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            addSampleBooks();
            initializeApp();
            
            // Добавляем стили для анимации
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // Сохраняем при закрытии
            window.addEventListener('beforeunload', async function() {
                saveBooksToLocalStorage();
                if (isYandexConnected) {
                    await saveBooksToYandex();
                }
            });
        });
    </script>
</body>
</html>